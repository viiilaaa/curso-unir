def waitForPort(int port, int retries = 30, int delay = 1) {
    for (int i = 0; i < retries; i++) {
        def result = sh(
            script: "nc -z localhost ${port}",
            returnStatus: true
        )
        if (result == 0) {
            echo "Port ${port} is UP!"
            return
        }
        echo "Waiting for port ${port}..."
        sleep delay
    }
    error "ERROR: Timeout waiting for port ${port}"
}

pipeline {
    agent any

    options { skipDefaultCheckout() }

    stages {
        stage('Inicial') {
            steps {
                echo 'Iniciando repositorio'
                git 'https://github.com/viiilaaa/curso-unir'
                bat 'dir'
                bat 'hostname'
                echo WORKSPACE
                stash name:'codigo', includes:'**'
            }
        }
        stage('build'){
            steps {
                bat 'echo "building..."'
            }
        }     
        stage('Tests'){
            parallel{
                stage('Unit') {
                    agent {label 'agent1'}
                    steps {
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            unstash name:'codigo'
                            sh '''
                                whoami
                                ls -la
                                export PYTHONPATH=${WORKSPACE}/Caso_practico1_1
                                pytest --junitxml=result-unit.xml Caso_practico1_1/test/unit
                            '''
                            stash name:'unit-result', includes:'result-unit.xml'
                       }
                    }
                }   
                stage('Rest') {
                    agent {label 'agent2'}
                    steps {
                      catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                        unstash name:'codigo'
                        sh '''
                            whoami
                            export FLASK_APP=Caso_practico1_1/app/api.py                          
                            flask run &
                        '''
                        waitForPort(5000)
                        
                        sh '''
                            java -jar /home/jenkins/agent2/wiremock/wiremock-standalone-3.13.2.jar --port 9090 --root-dir Caso_practico1_1/test/wiremock &
                        '''
                        waitForPort(9090)
                        
                        sh '''
                            export PYTHONPATH=${WORKSPACE}/Caso_practico1_1
                            pytest --junitxml=result-rest.xml Caso_practico1_1/test/rest
                        '''
                      }
                      stash name:'rest-result', includes:'result-rest.xml'
                    }    
                }                
                
            }
                
        }
        stage('Results'){
            steps {
                unstash name:'unit-result'
                unstash name:'rest-result'
                junit 'result*.xml'
            }
        }
    }
}
